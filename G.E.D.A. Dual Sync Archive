import React, { useState, useEffect, useRef, useMemo } from 'react';
import * as THREE from 'three';
import { 
  Settings2, Sun, Moon, RotateCw, Globe, 
  Zap, Palette, Maximize2, Activity, Languages,
  Hash, Shield, Cpu, Wind
} from 'lucide-react';

/**
 * CONFIG: システム設定
 */
const CONFIG = {
  VERSION: "2.9.1-ALPHA",
  TAG_COLORS: {
    '環境': { h: 180, s: 80, l: 50 },
    '身体': { h: 300, s: 80, l: 50 },
    '視覚': { h: 50, s: 90, l: 60 },
    '聴覚': { h: 140, s: 70, l: 50 },
    '心理': { h: 220, s: 80, l: 60 },
    'default': { h: 0, s: 0, l: 70 }
  },
  GLOBE_RADIUS: 100,
  CAMERA_DIST: 280,
  EARTH_ROT_BASE: 0.0000012,
  LANG: {
    jp: {
      title: "G.E.D.A. デュアル・シンクロ・アーカイブ",
      visual: "視覚構成",
      motion: "時間軸・自転",
      saturation: "彩度",
      luminance: "輝度",
      pointSize: "粒子サイズ",
      gridDensity: "グリッド密度",
      rotationSpeed: "自転同期係数",
      status: "ステータス: 稼働中",
      rotationMatch: "惑星自転: 同期済",
      rotationAccel: "時間加速: アクティブ",
      desc: "極めて希少な精神標本の記録"
    },
    en: {
      title: "G.E.D.A. DUAL SYNC ARCHIVE",
      visual: "Visual",
      motion: "Motion",
      saturation: "Saturation",
      luminance: "Luminance",
      pointSize: "Point Magnitude",
      gridDensity: "Grid Density",
      rotationSpeed: "Rotation Sync",
      status: "Status: Active",
      rotationMatch: "Planetary Rotation: Matched",
      rotationAccel: "Temporal Acceleration: Active",
      desc: "Preservation of Rare Mental Specimens"
    }
  },
  THEMES: {
    dark: {
      bg: 'radial-gradient(circle at center, #0a0f16 0%, #020406 100%)',
      ui: 'bg-slate-950/40',
      text: 'text-slate-100',
      gridColor: 0x334155,
      accent: 'text-cyan-400'
    },
    light: {
      bg: 'radial-gradient(circle at center, #f8fafc 0%, #e2e8f0 100%)',
      ui: 'bg-white/40',
      text: 'text-slate-900',
      gridColor: 0x94a3b8,
      accent: 'text-blue-600'
    }
  }
};

const MassivePointsGlobe = ({ data, settings, theme }) => {
  const mountRef = useRef(null);
  const globeGroupRef = useRef(new THREE.Group());
  const pointsRef = useRef(null);
  const globeMeshRef = useRef(null);
  const rendererRef = useRef(null);
  const settingsRef = useRef(settings);

  useEffect(() => { settingsRef.current = settings; }, [settings]);

  useEffect(() => {
    const width = mountRef.current.clientWidth;
    const height = mountRef.current.clientHeight;
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, width / height, 1, 2000);
    camera.position.z = CONFIG.CAMERA_DIST;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(width, height);
    mountRef.current.appendChild(renderer.domElement);
    rendererRef.current = renderer;

    scene.add(globeGroupRef.current);

    // ジオメトリ生成
    const globeGeom = new THREE.IcosahedronGeometry(CONFIG.GLOBE_RADIUS, 15);
    const globeMat = new THREE.MeshBasicMaterial({
      color: CONFIG.THEMES[theme].gridColor,
      wireframe: true,
      transparent: true,
      opacity: settings.gridOpacity
    });
    const globeMesh = new THREE.Mesh(globeGeom, globeMat);
    globeMeshRef.current = globeMesh;
    globeGroupRef.current.add(globeMesh);

    // 点群
    const positions = [];
    const colors = [];
    const latLngToVector3 = (lat, lng, radius) => {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lng + 180) * (Math.PI / 180);
      return new THREE.Vector3(
        -(radius * Math.sin(phi) * Math.cos(theta)),
        radius * Math.cos(phi),
        radius * Math.sin(phi) * Math.sin(theta)
      );
    };

    data.forEach((item) => {
      const pos = latLngToVector3(item.location.lat, item.location.lng, CONFIG.GLOBE_RADIUS + 2);
      positions.push(pos.x, pos.y, pos.z);
      const base = CONFIG.TAG_COLORS[item.tags[0]] || CONFIG.TAG_COLORS.default;
      const c = new THREE.Color().setHSL(base.h/360, base.s/100, base.l/100);
      colors.push(c.r, c.g, c.b);
    });

    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

    const pointsMat = new THREE.PointsMaterial({
      size: settings.pointSize,
      vertexColors: true,
      transparent: true,
      opacity: settings.opacity,
      blending: THREE.AdditiveBlending,
      sizeAttenuation: true
    });

    const points = new THREE.Points(geometry, pointsMat);
    pointsRef.current = points;
    globeGroupRef.current.add(points);

    // アニメーション
    let frameId;
    const animate = () => {
      frameId = requestAnimationFrame(animate);
      const speed = settingsRef.current.rotationSpeed * CONFIG.EARTH_ROT_BASE;
      globeGroupRef.current.rotation.y += speed;
      globeGroupRef.current.rotation.x += speed * 0.1;
      renderer.render(scene, camera);
    };
    animate();

    const handleResize = () => {
      if (!mountRef.current) return;
      camera.aspect = mountRef.current.clientWidth / mountRef.current.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
    };
    window.addEventListener('resize', handleResize);

    return () => {
      cancelAnimationFrame(frameId);
      window.removeEventListener('resize', handleResize);
      renderer.dispose();
    };
  }, [data]);

  useEffect(() => {
    if (!pointsRef.current || !globeMeshRef.current) return;
    const colorsAttr = pointsRef.current.geometry.attributes.color;
    data.forEach((item, i) => {
      const base = CONFIG.TAG_COLORS[item.tags[0]] || CONFIG.TAG_COLORS.default;
      const color = new THREE.Color();
      color.setHSL(base.h / 360, (base.s / 100) * settings.saturation, (base.l / 100) * settings.luminance);
      colorsAttr.setXYZ(i, color.r, color.g, color.b);
    });
    colorsAttr.needsUpdate = true;
    pointsRef.current.material.size = settings.pointSize;
    globeMeshRef.current.material.opacity = settings.gridOpacity;
    globeMeshRef.current.material.color.setHex(CONFIG.THEMES[theme].gridColor);
  }, [settings.saturation, settings.luminance, settings.pointSize, settings.gridOpacity, theme, data]);

  return <div ref={mountRef} className="w-full h-full cursor-crosshair" />;
};

const App = () => {
  const [theme, setTheme] = useState('dark');
  const [lang, setLang] = useState('jp');
  const [activeTab, setActiveTab] = useState('visual');
  const [showPanel, setShowPanel] = useState(false);
  const [settings, setSettings] = useState({
    pointSize: 3.2,
    luminance: 1.2,
    saturation: 1.0,
    opacity: 0.8,
    rotationSpeed: 1.0,
    gridOpacity: 0.15
  });

  const t = CONFIG.LANG[lang];
  const currentTheme = CONFIG.THEMES[theme];

  const archiveData = useMemo(() => [
    { id: "S-101", tags: ["環境"], location: { lat: 35.6, lng: 139.7 }, val: "0.82" },
    { id: "S-102", tags: ["身体"], location: { lat: 48.8, lng: 2.3 }, val: "0.45" },
    { id: "S-103", tags: ["視覚"], location: { lat: 40.7, lng: -74.0 }, val: "0.91" },
    { id: "S-104", tags: ["聴覚"], location: { lat: -33.8, lng: 151.2 }, val: "0.33" },
    { id: "S-105", tags: ["心理"], location: { lat: 55.7, lng: 37.6 }, val: "0.77" },
    { id: "S-106", tags: ["心理"], location: { lat: 34.6, lng: 135.5 }, val: "0.99" },
    { id: "S-107", tags: ["環境"], location: { lat: -23.5, lng: -46.6 }, val: "0.12" },
  ], []);

  return (
    <div className={`fixed inset-0 font-sans transition-colors duration-1000 overflow-hidden select-none`} style={{ background: currentTheme.bg }}>
      
      {/* 背景装飾 */}
      <div className="absolute inset-0 opacity-20 pointer-events-none" 
           style={{ backgroundImage: `radial-gradient(${theme === 'dark' ? '#ffffff22' : '#00000011'} 1px, transparent 0)`, backgroundSize: '40px 40px' }} />

      <header className="absolute top-0 w-full flex items-start justify-between p-10 z-50">
        <div className="space-y-1">
          <div className="flex items-center gap-4">
            <div className={`w-3 h-3 ${theme === 'dark' ? 'bg-cyan-500 shadow-[0_0_15px_#06b6d4]' : 'bg-blue-600'} rounded-full animate-pulse`} />
            <h1 className={`text-lg font-black tracking-[0.5em] uppercase ${currentTheme.text}`}>
              {t.title}
            </h1>
          </div>
          <div className="flex items-center gap-6 mt-4">
            <div className={`text-[10px] tracking-[0.2em] font-mono opacity-60 flex items-center gap-2 ${currentTheme.text}`}>
              <Hash size={12} className="text-cyan-500" /> V.{CONFIG.VERSION}
            </div>
            <div className={`text-[10px] tracking-[0.2em] font-mono opacity-60 flex items-center gap-2 ${currentTheme.text}`}>
              <Shield size={12} className="text-cyan-500" /> {t.status}
            </div>
            <div className={`text-[10px] tracking-[0.2em] italic opacity-40 ${currentTheme.text}`}>
               // {t.desc}
            </div>
          </div>
        </div>

        <div className="flex gap-4">
          <button onClick={() => setLang(lang === 'jp' ? 'en' : 'jp')} 
            className={`w-12 h-12 flex items-center justify-center rounded-full border border-current/10 backdrop-blur-3xl transition-all hover:scale-110 active:scale-90 ${currentTheme.text} ${currentTheme.ui}`}>
            <Languages size={18} />
          </button>
          <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} 
            className={`w-12 h-12 flex items-center justify-center rounded-full border border-current/10 backdrop-blur-3xl transition-all hover:scale-110 active:scale-90 ${currentTheme.text} ${currentTheme.ui}`}>
            {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
          </button>
          <button onClick={() => setShowPanel(!showPanel)} 
            className={`w-12 h-12 flex items-center justify-center rounded-full border border-current/10 backdrop-blur-3xl transition-all hover:scale-110 active:scale-90 ${showPanel ? 'bg-cyan-500 text-white border-none shadow-lg shadow-cyan-500/20' : currentTheme.text} ${currentTheme.ui}`}>
            <Settings2 size={18} className={showPanel ? "animate-spin-slow" : ""} />
          </button>
        </div>
      </header>

      {/* 調整パネル */}
      <div className={`absolute top-28 right-10 w-80 backdrop-blur-3xl rounded-[32px] border border-white/10 shadow-2xl z-50 transition-all duration-700 ease-out overflow-hidden ${showPanel ? 'translate-y-0 opacity-100' : 'translate-y-8 opacity-0 pointer-events-none'} ${currentTheme.ui} ${currentTheme.text}`}>
        <div className="p-8">
          <div className="flex gap-8 mb-10">
            {['visual', 'motion'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)}
                className={`text-[11px] uppercase tracking-[0.3em] pb-3 transition-all relative ${activeTab === tab ? 'text-cyan-400 font-bold' : 'opacity-30 hover:opacity-60'}`}>
                {t[tab]}
                {activeTab === tab && <div className="absolute bottom-0 left-0 w-full h-0.5 bg-cyan-400" />}
              </button>
            ))}
          </div>

          <div className="space-y-10">
            {activeTab === 'visual' ? (
              <>
                <SliderItem label={t.saturation} icon={<Palette size={14}/>} value={settings.saturation} min={0} max={2} step={0.01}
                  onChange={v => setSettings(s => ({...s, saturation: v}))} theme={theme} />
                <SliderItem label={t.luminance} icon={<Zap size={14}/>} value={settings.luminance} min={0.5} max={2.5} step={0.01}
                  onChange={v => setSettings(s => ({...s, luminance: v}))} theme={theme} />
                <SliderItem label={t.pointSize} icon={<Maximize2 size={14}/>} value={settings.pointSize} min={0.5} max={10} step={0.1}
                  onChange={v => setSettings(s => ({...s, pointSize: v}))} theme={theme} />
                <SliderItem label={t.gridDensity} icon={<Globe size={14}/>} value={settings.gridOpacity} min={0} max={0.5} step={0.01}
                  onChange={v => setSettings(s => ({...s, gridOpacity: v}))} theme={theme} />
              </>
            ) : (
              <SliderItem label={t.rotationSpeed} icon={<RotateCw size={14}/>} value={settings.rotationSpeed} min={1} max={5000} step={1}
                onChange={v => setSettings(s => ({...s, rotationSpeed: v}))} theme={theme} />
            )}
          </div>
        </div>
        <div className="bg-white/5 p-4 text-center">
           <p className="text-[9px] opacity-30 tracking-widest font-mono uppercase">Synchronization Interface v2.9</p>
        </div>
      </div>

      <MassivePointsGlobe data={archiveData} settings={settings} theme={theme} />

      {/* 左下のステータス */}
      <footer className="absolute bottom-12 left-12 z-50 pointer-events-none">
        <div className="space-y-6">
          <div className="flex gap-4">
            <div className={`p-4 backdrop-blur-2xl rounded-2xl border border-white/5 ${currentTheme.ui}`}>
               <div className="flex items-center gap-3">
                 <Cpu size={14} className="text-cyan-500" />
                 <span className={`text-[10px] font-mono tracking-widest ${currentTheme.text}`}>
                   CORE_SYNC: {settings.rotationSpeed === 1.0 ? "STABLE" : "OVERDRIVE"}
                 </span>
               </div>
            </div>
            <div className={`p-4 backdrop-blur-2xl rounded-2xl border border-white/5 ${currentTheme.ui}`}>
               <div className="flex items-center gap-3">
                 <Wind size={14} className="text-purple-500" />
                 <span className={`text-[10px] font-mono tracking-widest ${currentTheme.text}`}>
                   OSCILLATION: {settings.luminance.toFixed(2)}
                 </span>
               </div>
            </div>
          </div>

          <div className="border-l-[3px] border-cyan-500 pl-6 py-2 transition-all duration-500">
            <div className={`text-xs font-bold font-mono tracking-[0.25em] ${currentTheme.text}`}>
              {settings.rotationSpeed === 1.0 ? t.rotationMatch : t.rotationAccel}
            </div>
            <div className="flex gap-6 mt-4 opacity-40">
              {Object.keys(CONFIG.TAG_COLORS).filter(k => k !== 'default').map(tag => (
                <div key={tag} className="flex items-center gap-2 group transition-opacity hover:opacity-100">
                  <div className="w-1.5 h-1.5 rounded-full shadow-[0_0_8px_currentColor]" style={{ backgroundColor: `hsl(${CONFIG.TAG_COLORS[tag].h}, 80%, 60%)`, color: `hsl(${CONFIG.TAG_COLORS[tag].h}, 80%, 60%)` }} />
                  <span className={`text-[9px] font-bold uppercase tracking-widest ${currentTheme.text}`}>{tag}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </footer>

      {/* 右下のアーカイブリスト */}
      <div className="absolute bottom-12 right-12 z-50 text-right opacity-30 hover:opacity-100 transition-opacity duration-700 hidden lg:block">
         <div className="space-y-1">
           {archiveData.map(d => (
             <div key={d.id} className={`text-[8px] font-mono tracking-tighter ${currentTheme.text} flex items-center justify-end gap-2`}>
               <span>{d.id}</span>
               <span className="w-12 h-[1px] bg-current opacity-20" />
               <span className="opacity-60">LAT:{d.location.lat} LNG:{d.location.lng}</span>
               <span className="text-cyan-500 font-bold">[{d.val}]</span>
             </div>
           ))}
         </div>
      </div>

      <style>{`
        @keyframes spin-slow {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
          animation: spin-slow 8s linear infinite;
        }
        input[type='range']::-webkit-slider-thumb {
          -webkit-appearance: none;
          height: 16px;
          width: 16px;
          border-radius: 50%;
          background: #06b6d4;
          box-shadow: 0 0 10px #06b6d488;
          cursor: pointer;
          transition: transform 0.2s;
        }
        input[type='range']::-webkit-slider-thumb:hover {
          transform: scale(1.2);
        }
      `}</style>
    </div>
  );
};

const SliderItem = ({ label, icon, value, min, max, step, onChange, theme }) => (
  <div className="group">
    <div className="flex justify-between items-center text-[10px] tracking-[0.2em] uppercase opacity-40 group-hover:opacity-100 transition-opacity mb-4">
      <span className="flex items-center gap-3">{icon} {label}</span>
      <span className="font-mono text-cyan-400 font-bold">{value >= 1000 ? (value/1000).toFixed(1) + "k" : value.toFixed(1)}</span>
    </div>
    <div className="relative flex items-center">
      <input type="range" min={min} max={max} step={step} value={value}
        onChange={e => onChange(parseFloat(e.target.value))}
        className="w-full h-[2px] bg-current/10 rounded-full appearance-none cursor-pointer accent-cyan-500" />
    </div>
  </div>
);

export default App;
