import React, { useState, useEffect, useRef, useMemo } from 'react';
import * as THREE from 'three';
import { 
  Settings2, Sun, Moon, RotateCw, Globe, 
  Zap, Maximize2, Activity, Languages,
  Hash, Shield, Cpu, Wind, Clock, Compass, Grid,
  Maximize, Type, Watch, Circle, Eye, ExternalLink,
  Lock, Terminal, ChevronRight, Search
} from 'lucide-react';

/**
 * CONFIG: システム設定 (保守運用五則 第2条-1)
 * IDやURL、初期値を外部化し、ハードコーディングを回避
 */
const CONFIG = {
  VERSION_NAME: "V.3.2.8-CHRONOS-REFINED",
  APP_ID: "GEDA-ARC-REF-09",
  GLOBE_RADIUS: 100,
  CAMERA_DIST: 280,
  EARTH_ROT_BASE: 0.0000012,
  FRICTION: 0.95,
  RETURN_LERP: 0.02,
  TAG_COLORS: {
    '環境': { h: 180, s: 80, l: 50 },
    '身体': { h: 300, s: 80, l: 50 },
    '視覚': { h: 50, s: 90, l: 60 },
    '聴覚': { h: 140, s: 70, l: 50 },
    '心理': { h: 220, s: 80, l: 60 },
    'default': { h: 0, s: 0, l: 70 }
  },
  LANG: {
    jp: {
      title: "G.E.D.A. デュアル・シンクロ・アーカイブ",
      visual: "視覚構成",
      motion: "時間軸",
      clockSettings: "時計設定",
      globeScale: "地球儀サイズ",
      clockSize: "時計サイズ",
      luminance: "輝度",
      pointSize: "粒子サイズ",
      gridDensity: "グリッド密度",
      gridOpacity: "グリッド明度",
      rotationSpeed: "自転同期係数",
      status: "稼働中",
      clockMode: "フォーカスモード",
      clockType: "表示形式",
      fontFamily: "書体",
      indexType: "目盛り",
      handType: "針の形状",
      showSeconds: "秒針を表示",
      showMilli: "ミリ秒を表示",
      showFrame: "外枠を表示",
      days: ["日", "月", "火", "水", "木", "金", "土"]
    },
    en: {
      title: "G.E.D.A. DUAL SYNC ARCHIVE",
      visual: "Visual",
      motion: "Motion",
      clockSettings: "Clock",
      globeScale: "Globe Scale",
      clockSize: "Clock Scale",
      luminance: "Luminance",
      pointSize: "Point Magnitude",
      gridDensity: "Grid Density",
      gridOpacity: "Grid Luminance",
      rotationSpeed: "Rotation Sync",
      status: "Active",
      clockMode: "Focus Mode",
      clockType: "Type",
      fontFamily: "Font",
      indexType: "Index",
      handType: "Hand Style",
      showSeconds: "Show Seconds",
      showMilli: "Show Millis",
      showFrame: "Show Frame",
      days: ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"]
    }
  },
  THEMES: {
    dark: {
      bg: 'radial-gradient(circle at center, #0a0f16 0%, #020406 100%)',
      ui: 'bg-slate-950/40',
      text: 'text-slate-100',
      gridColor: 0x334155,
      accent: 'text-cyan-400'
    },
    light: {
      bg: 'radial-gradient(circle at center, #f8fafc 0%, #e2e8f0 100%)',
      ui: 'bg-white/40',
      text: 'text-slate-900',
      gridColor: 0x94a3b8,
      accent: 'text-blue-600'
    }
  }
};

/**
 * 3D Globe Component (Three.js integration)
 * 地球儀の回転、ドラッグ操作、グリッド表示、データポイント表示を司る
 */
const MassivePointsGlobe = ({ data, settings, theme }) => {
  const mountRef = useRef(null);
  const globeGroupRef = useRef(new THREE.Group());
  const interactionGroupRef = useRef(new THREE.Group());
  const pointsRef = useRef(null);
  const globeMeshRef = useRef(null);
  const rendererRef = useRef(null);
  const sceneRef = useRef(new THREE.Scene());
  const settingsRef = useRef(settings);
  
  const isDragging = useRef(false);
  const previousMousePosition = useRef({ x: 0, y: 0 });
  const velocity = useRef({ x: 0, y: 0 });

  useEffect(() => { settingsRef.current = settings; }, [settings]);

  // グリッド（メッシュ）の更新ロジック
  const updateGridGeometry = (density) => {
    try {
      if (globeMeshRef.current) {
        globeGroupRef.current.remove(globeMeshRef.current);
        globeMeshRef.current.geometry.dispose();
        globeMeshRef.current.material.dispose();
      }
      if (density <= 0) {
        globeMeshRef.current = null;
        return;
      }
      const globeGeom = new THREE.IcosahedronGeometry(CONFIG.GLOBE_RADIUS, Math.floor(density));
      const globeMat = new THREE.MeshBasicMaterial({
        color: CONFIG.THEMES[theme].gridColor,
        wireframe: true,
        transparent: true,
        opacity: settingsRef.current.gridOpacity // ステートから明度を反映
      });
      const globeMesh = new THREE.Mesh(globeGeom, globeMat);
      globeMeshRef.current = globeMesh;
      globeGroupRef.current.add(globeMesh);
    } catch (e) {
      console.error("Grid Render Error:", e);
    }
  };

  useEffect(() => {
    const width = mountRef.current.clientWidth;
    const height = mountRef.current.clientHeight;
    const scene = sceneRef.current;
    const camera = new THREE.PerspectiveCamera(45, width / height, 1, 2000);
    camera.position.z = CONFIG.CAMERA_DIST;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(width, height);
    mountRef.current.appendChild(renderer.domElement);
    rendererRef.current = renderer;

    scene.add(interactionGroupRef.current);
    interactionGroupRef.current.add(globeGroupRef.current);

    updateGridGeometry(settings.gridDensity);

    // 緯度経度からVector3への変換
    const latLngToVector3 = (lat, lng, radius) => {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lng + 180) * (Math.PI / 180);
      return new THREE.Vector3(
        -(radius * Math.sin(phi) * Math.cos(theta)),
        radius * Math.cos(phi),
        radius * Math.sin(phi) * Math.sin(theta)
      );
    };

    // ポイントデータの構築
    const positions = [];
    const colors = [];
    data.forEach((item) => {
      const pos = latLngToVector3(item.location.lat, item.location.lng, CONFIG.GLOBE_RADIUS + 2);
      positions.push(pos.x, pos.y, pos.z);
      const base = CONFIG.TAG_COLORS[item.tags[0]] || CONFIG.TAG_COLORS.default;
      const c = new THREE.Color().setHSL(base.h/360, base.s/100, base.l/100);
      colors.push(c.r, c.g, c.b);
    });

    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

    const pointsMat = new THREE.PointsMaterial({
      size: settings.pointSize,
      vertexColors: true,
      transparent: true,
      opacity: settings.opacity,
      blending: THREE.AdditiveBlending,
      sizeAttenuation: true
    });

    const points = new THREE.Points(geometry, pointsMat);
    pointsRef.current = points;
    globeGroupRef.current.add(points);

    // マウス/タッチ操作ハンドラ
    const onMouseDown = (e) => {
      isDragging.current = true;
      previousMousePosition.current = { 
        x: e.clientX || e.touches?.[0].clientX, 
        y: e.clientY || e.touches?.[0].clientY 
      };
      velocity.current = { x: 0, y: 0 };
    };

    const onMouseMove = (e) => {
      if (!isDragging.current) return;
      const clientX = e.clientX || e.touches?.[0].clientX;
      const clientY = e.clientY || e.touches?.[0].clientY;
      const deltaX = clientX - previousMousePosition.current.x;
      const deltaY = clientY - previousMousePosition.current.y;
      interactionGroupRef.current.rotation.y += deltaX * 0.005;
      interactionGroupRef.current.rotation.x += deltaY * 0.005;
      velocity.current = { x: deltaX * 0.005, y: deltaY * 0.005 };
      previousMousePosition.current = { x: clientX, y: clientY };
    };

    const onMouseUp = () => { isDragging.current = false; };

    mountRef.current.addEventListener('mousedown', onMouseDown);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
    mountRef.current.addEventListener('touchstart', onMouseDown);
    window.addEventListener('touchmove', onMouseMove, { passive: false });
    window.addEventListener('touchend', onMouseUp);

    let frameId;
    const animate = () => {
      frameId = requestAnimationFrame(animate);
      const baseSpeed = settingsRef.current.rotationSpeed * CONFIG.EARTH_ROT_BASE;
      globeGroupRef.current.rotation.y += baseSpeed;

      if (!isDragging.current) {
        interactionGroupRef.current.rotation.y += velocity.current.x;
        interactionGroupRef.current.rotation.x += velocity.current.y;
        velocity.current.x *= CONFIG.FRICTION;
        velocity.current.y *= CONFIG.FRICTION;
        interactionGroupRef.current.rotation.x *= (1 - CONFIG.RETURN_LERP);
      }
      renderer.render(scene, camera);
    };
    animate();

    return () => {
      cancelAnimationFrame(frameId);
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('mouseup', onMouseUp);
      window.removeEventListener('touchmove', onMouseMove);
      window.removeEventListener('touchend', onMouseUp);
      renderer.dispose();
    };
  }, [data]);

  useEffect(() => {
    updateGridGeometry(settings.gridDensity);
  }, [settings.gridDensity]);

  useEffect(() => {
    if (!pointsRef.current) return;
    globeGroupRef.current.scale.set(settings.globeScale, settings.globeScale, settings.globeScale);
    const colorsAttr = pointsRef.current.geometry.attributes.color;
    data.forEach((item, i) => {
      const base = CONFIG.TAG_COLORS[item.tags[0]] || CONFIG.TAG_COLORS.default;
      const color = new THREE.Color();
      color.setHSL(base.h / 360, base.s / 100, (base.l / 100) * settings.luminance);
      colorsAttr.setXYZ(i, color.r, color.g, color.b);
    });
    colorsAttr.needsUpdate = true;
    pointsRef.current.material.size = settings.pointSize;
    if (globeMeshRef.current) {
      globeMeshRef.current.material.opacity = settings.gridOpacity;
      globeMeshRef.current.material.color.setHex(CONFIG.THEMES[theme].gridColor);
    }
  }, [settings.globeScale, settings.luminance, settings.pointSize, settings.gridOpacity, theme, data]);

  return <div ref={mountRef} className="w-full h-full cursor-grab active:cursor-grabbing" />;
};

/**
 * Precision Clock Component
 * デジタル/アナログの切り替え、ミリ秒表示、カスタムフォント制御
 */
const PrecisionClock = ({ theme, config, isMainMode, lang = 'jp' }) => {
  const [time, setTime] = useState(new Date());

  useEffect(() => {
    const isMilliActive = isMainMode ? config.showMilli : true; 
    const interval = isMilliActive ? 16 : 1000;
    const timer = setInterval(() => setTime(new Date()), interval);
    return () => clearInterval(timer);
  }, [isMainMode, config.showMilli]);

  const h = time.getHours();
  const m = time.getMinutes();
  const s = time.getSeconds();
  const ms = time.getMilliseconds();
  const dw = time.getDay();
  const pad = (v) => String(v).padStart(2, '0');
  
  const dayStr = CONFIG.LANG[lang].days[dw];

  // フォーカスモードでない時のフッター用表示
  if (!isMainMode) {
    return (
      <div className={`font-mono text-[9px] tracking-[0.3em] flex items-center gap-2 opacity-60 ${theme === 'dark' ? 'text-white' : 'text-slate-900'}`}>
        <span>{time.getFullYear()}.{pad(time.getMonth()+1)}.{pad(time.getDate())} ({dayStr})</span>
        <span className="opacity-20">|</span>
        <span className="font-bold">{pad(h)}:{pad(m)}:{pad(s)}</span>
        <span className="text-cyan-500 font-bold w-[1.5em]">{pad(Math.floor(ms/10))}</span>
      </div>
    );
  }

  const resolvedFont = config.fontFamily === 'serif' ? '"Noto Serif JP", serif' : 
                       config.fontFamily === 'mono' ? '"Space Mono", monospace' : 
                       '"Noto Sans JP", sans-serif';

  const containerStyle = {
    fontFamily: resolvedFont,
    transform: `scale(${config.clockSize})`
  };
// 秒針の動き
 if (config.clockType === 'analog') {
  const hDeg = (h % 12) * 30 + m * 0.5 + s * (0.5 / 60);
const mDeg = m * 6 + s * 0.1 + ms * 0.0001;
const sDeg = s * 6 + ms * 0.006;

    const renderIndex = () => {
      if (config.indexType === 'none') return null;
      const points = config.indexType === 'full' ? [1,2,3,4,5,6,7,8,9,10,11,12] : [12,3,6,9];
      return points.map(num => {
        const angle = (num * 30 - 90) * (Math.PI / 180);
        const x = 50 + 38 * Math.cos(angle);
        const y = 50 + 38 * Math.sin(angle);
        return (
          <text key={num} x={x} y={y} fill="currentColor" fontSize="6" textAnchor="middle" dominantBaseline="middle" 
                style={{ fontWeight: config.fontFamily === 'mono' ? '400' : '900', opacity: 0.6 }}>
            {num}
          </text>
        );
      });
    };

    const getHandPath = (type, length) => {
      if (type === 'minimal') return `M 50 50 L 50 ${50 - length}`;
      if (type === 'tapered') return `M 50 50 L 48 50 L 50 ${50 - length} L 52 50 Z`;
      return `M 49 50 L 49 ${50 - length} L 51 ${50 - length} L 51 50 Z`;
    };

    return (
      <div className={`relative transition-all duration-1000 ${theme === 'dark' ? 'text-white' : 'text-slate-900'}`} style={{ width: '400px', height: '400px' }}>
        <div style={containerStyle} className="w-full h-full">
          <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-2xl">
            {config.showFrame && <circle cx="50" cy="50" r="48" fill="none" stroke="currentColor" strokeWidth="0.5" strokeOpacity="0.1" />}
            {renderIndex()}
            <g style={{ transform: `rotate(${hDeg}deg)`, transformOrigin: '50% 50%' }} className="transition-transform duration-500 ease-out">
  {config.handType === 'minimal' ? (
    <line x1="50" y1="50" x2="50" y2="25" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" />
  ) : (
    <path d={getHandPath(config.handType, 25)} fill="currentColor" />
  )}
</g>
<g style={{ transform: `rotate(${mDeg}deg)`, transformOrigin: '50% 50%' }} className="transition-transform duration-300 ease-out">
  {config.handType === 'minimal' ? (
    <line x1="50" y1="50" x2="50" y2="15" stroke="currentColor" strokeWidth="1" strokeLinecap="round" opacity="0.8" />
  ) : (
    <path d={getHandPath(config.handType, 35)} fill="currentColor" strokeOpacity="0.8" />
  )}
</g>
            {config.showSeconds && (
              <g style={{ transform: `rotate(${sDeg}deg)`, transformOrigin: '50% 50%' }}>
                <line x1="50" y1="50" x2="50" y2="10" stroke="#06b6d4" strokeWidth="0.5" />
                <circle cx="50" cy="50" r="1.5" fill="#06b6d4" />
              </g>
            )}
            <circle cx="50" cy="50" r="0.8" fill="currentColor" />
          </svg>
        </div>
      </div>
    );
  }

  // デジタル時計表示
  return (
    <div className={`flex flex-col items-center justify-center transition-all duration-1000 ${theme === 'dark' ? 'text-white' : 'text-slate-900'}`} style={containerStyle}>
      <div className="flex items-baseline">
        <span className={`inline-block w-[1.2em] text-center text-7xl ${config.fontFamily === 'mono' ? 'font-normal' : 'font-black'}`}>{pad(h)}</span>
        <span className="text-4xl opacity-20 mx-2 select-none">:</span>
        <span className={`inline-block w-[1.2em] text-center text-7xl ${config.fontFamily === 'mono' ? 'font-normal' : 'font-black'}`}>{pad(m)}</span>
        {config.showSeconds && (
          <>
            <span className="text-4xl opacity-20 mx-2 select-none">:</span>
            <span className={`inline-block w-[1.2em] text-center text-7xl ${config.fontFamily === 'mono' ? 'font-normal' : 'font-black'}`}>{pad(s)}</span>
          </>
        )}
        {config.showMilli && (
          <span className="inline-block w-[1.5em] text-left text-3xl ml-4 text-cyan-500 font-bold">{pad(Math.floor(ms/10))}</span>
        )}
      </div>
      <div className="mt-4 text-[10px] tracking-[0.5em] opacity-40 uppercase">
        {time.getFullYear()}.{pad(time.getMonth()+1)}.{pad(time.getDate())} ({dayStr})
      </div>
    </div>
  );
};

/**
 * Common UI Components
 */
const SliderItem = ({ label, icon, value, min, max, step, onChange }) => (
  <div className="group">
    <div className="flex justify-between items-center text-[8px] tracking-[0.2em] uppercase opacity-30 group-hover:opacity-100 transition-opacity mb-2">
      <span className="flex items-center gap-2">{icon} {label}</span>
      <span className="font-mono text-cyan-400 font-bold">{typeof value === 'number' ? value.toFixed(2) : value}</span>
    </div>
    <input type="range" min={min} max={max} step={step} value={value}
      onChange={e => onChange(parseFloat(e.target.value))}
      className="w-full h-[1px] bg-current/10 rounded-full appearance-none cursor-pointer accent-cyan-500" />
  </div>
);

const SelectGroup = ({ label, options, value, icon, onChange }) => (
  <div className="space-y-2">
    <div className="flex items-center gap-2 text-[8px] tracking-[0.2em] uppercase opacity-30">
      {icon} {label}
    </div>
    <div className="flex bg-black/10 rounded-lg p-0.5 gap-0.5">
      {options.map(opt => (
        <button key={opt} onClick={() => onChange(opt)}
                className={`flex-1 py-1 text-[7px] uppercase tracking-widest rounded-md transition-all ${value === opt ? 'bg-cyan-500 text-white' : 'opacity-30 hover:opacity-100'}`}>
          {opt}
        </button>
      ))}
    </div>
  </div>
);

const ToggleItem = ({ label, active, onClick }) => (
  <button onClick={onClick} className={`p-2 rounded-lg border text-[7px] tracking-widest uppercase transition-all flex items-center justify-center gap-1.5 ${active ? 'bg-cyan-500/10 border-cyan-500 text-cyan-400' : 'border-white/5 opacity-30 hover:opacity-60'}`}>
    {active ? <Shield size={8}/> : <Circle size={8} className="opacity-10"/>}
    {label}
  </button>
);

/**
 * Main Application Root
 */
const App = () => {
  const [theme, setTheme] = useState('dark');
  const [lang, setLang] = useState('jp');
  const [activeTab, setActiveTab] = useState('visual');
  const [showPanel, setShowPanel] = useState(false);
  const [clockMode, setClockMode] = useState(false);

  // 視覚設定
  const [settings, setSettings] = useState({
    globeScale: 1.0,
    pointSize: 3.5,
    luminance: 1.5,
    opacity: 0.8,
    rotationSpeed: 1.0,
    gridOpacity: 0.15,
    gridDensity: 15
  });

  // 時計構成設定
  const [clockConfig, setClockConfig] = useState({
    clockType: 'digital',
    fontFamily: 'sans',
    indexType: 'full',
    handType: 'tapered',
    clockSize: 1.0,
    showSeconds: true,
    showMilli: true,
    showFrame: true
  });

  const t = CONFIG.LANG[lang];
  const currentTheme = CONFIG.THEMES[theme];

  // ダミー標本データ
  const archiveData = useMemo(() => [
    { id: "S-101", tags: ["環境"], location: { lat: 35.6, lng: 139.7 } },
    { id: "S-102", tags: ["身体"], location: { lat: 48.8, lng: 2.3 } },
    { id: "S-103", tags: ["視覚"], location: { lat: 40.7, lng: -74.0 } },
    { id: "S-104", tags: ["聴覚"], location: { lat: -33.8, lng: 151.2 } },
    { id: "S-105", tags: ["心理"], location: { lat: 55.7, lng: 37.6 } },
    { id: "S-106", tags: ["心理"], location: { lat: 34.6, lng: 135.5 } },
    { id: "S-107", tags: ["環境"], location: { lat: -23.5, lng: -46.6 } },
    { id: "S-108", tags: ["身体"], location: { lat: 1.3, lng: 103.8 } },
    { id: "S-109", tags: ["視覚"], location: { lat: 51.5, lng: -0.1 } },
  ], []);

  return (
    <div className={`fixed inset-0 font-sans transition-all duration-1000 overflow-hidden select-none`} style={{ background: currentTheme.bg }}>
      
      {/* 背景方眼デコレーション */}
      <div className="absolute inset-0 opacity-10 pointer-events-none" 
           style={{ backgroundImage: `radial-gradient(${theme === 'dark' ? '#ffffff22' : '#00000011'} 1px, transparent 0)`, backgroundSize: '60px 60px' }} />

      {/* システムヘッダー */}
      <header className={`absolute top-0 w-full flex items-start justify-between p-10 z-50 transition-opacity duration-1000 ${clockMode ? 'opacity-20 hover:opacity-100' : 'opacity-100'}`}>
        <div className="space-y-1">
          <div className="flex items-center gap-4">
            <div className={`w-2 h-2 ${theme === 'dark' ? 'bg-cyan-500 shadow-[0_0_10px_#06b6d4]' : 'bg-blue-600'} rounded-full animate-pulse`} />
            <h1 className={`text-[10px] font-black tracking-[0.6em] uppercase ${currentTheme.text}`}>
              {t.title}
            </h1>
          </div>
          <div className={`text-[8px] tracking-[0.2em] font-mono mt-2 opacity-30 ${currentTheme.text}`}>
             {CONFIG.VERSION_NAME} // NODE_{CONFIG.APP_ID}
          </div>
        </div>

        <div className="flex gap-4">
          <button onClick={() => setLang(lang === 'jp' ? 'en' : 'jp')} className={`w-8 h-8 flex items-center justify-center rounded-full border border-current/10 backdrop-blur-3xl transition-all hover:scale-110 active:scale-90 ${currentTheme.text} ${currentTheme.ui}`}>
            <Languages size={14} />
          </button>
          <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className={`w-8 h-8 flex items-center justify-center rounded-full border border-current/10 backdrop-blur-3xl transition-all hover:scale-110 active:scale-90 ${currentTheme.text} ${currentTheme.ui}`}>
            {theme === 'dark' ? <Sun size={14} /> : <Moon size={14} />}
          </button>
          <button onClick={() => setShowPanel(!showPanel)} className={`w-8 h-8 flex items-center justify-center rounded-full border border-current/10 backdrop-blur-3xl transition-all hover:scale-110 active:scale-90 ${showPanel ? 'bg-cyan-500 text-white border-none' : currentTheme.text} ${currentTheme.ui}`}>
            <Settings2 size={14} className={showPanel ? "animate-spin-slow" : ""} />
          </button>
        </div>
      </header>

      {/* フォーカスモード時の巨大時計 */}
      <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-40 transition-all duration-1000 ${clockMode ? 'scale-100 opacity-100' : 'scale-75 opacity-0 pointer-events-none'}`}>
        <PrecisionClock theme={theme} config={clockConfig} isMainMode={true} lang={lang} />
      </div>

      {/* 設定コントロールパネル (不退転のロジック層) */}
      <div className={`absolute top-20 right-10 w-72 backdrop-blur-3xl rounded-[24px] border border-white/10 shadow-2xl z-50 transition-all duration-500 ease-out overflow-hidden ${showPanel ? 'translate-y-0 opacity-100' : 'translate-y-4 opacity-0 pointer-events-none'} ${currentTheme.ui} ${currentTheme.text}`}>
        <div className="p-6">
          <div className="flex gap-4 mb-6 overflow-x-auto no-scrollbar">
            {['visual', 'motion', 'clockSettings'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)}
                className={`text-[9px] uppercase tracking-[0.2em] pb-1.5 transition-all whitespace-nowrap relative ${activeTab === tab ? 'text-cyan-400 font-bold' : 'opacity-30 hover:opacity-60'}`}>
                {t[tab]}
                {activeTab === tab && <div className="absolute bottom-0 left-0 w-full h-0.5 bg-cyan-400" />}
              </button>
            ))}
          </div>

          <div className="space-y-6 max-h-[50vh] overflow-y-auto pr-2 no-scrollbar">
            {activeTab === 'visual' && (
              <>
                <SliderItem label={t.globeScale} icon={<Maximize size={10}/>} value={settings.globeScale} min={0.5} max={2.5} step={0.01} onChange={v => setSettings(s => ({...s, globeScale: v}))} />
                <SliderItem label={t.pointSize} icon={<Eye size={10}/>} value={settings.pointSize} min={0.5} max={10.0} step={0.1} onChange={v => setSettings(s => ({...s, pointSize: v}))} />
                <SliderItem label={t.luminance} icon={<Zap size={10}/>} value={settings.luminance} min={0.5} max={2.5} step={0.01} onChange={v => setSettings(s => ({...s, luminance: v}))} />
                <SliderItem label={t.gridDensity} icon={<Grid size={10}/>} value={settings.gridDensity} min={0} max={30} step={1} onChange={v => setSettings(s => ({...s, gridDensity: v}))} />
                {/* 復元ポイント: グリッド明度（Grid Luminance）のスライダー */}
                <SliderItem label={t.gridOpacity} icon={<Compass size={10}/>} value={settings.gridOpacity} min={0} max={1.0} step={0.01} onChange={v => setSettings(s => ({...s, gridOpacity: v}))} />
              </>
            )}
            
            {activeTab === 'motion' && (
              <div className="space-y-6">
                <SliderItem label={t.rotationSpeed} icon={<RotateCw size={10}/>} value={settings.rotationSpeed} min={1} max={5000} step={1} onChange={v => setSettings(s => ({...s, rotationSpeed: v}))} />
                <div className="p-4 bg-white/5 rounded-lg border border-white/5 space-y-2">
                   <div className="flex items-center gap-2 text-[7px] text-cyan-500 uppercase font-bold tracking-widest"><Activity size={8}/> Dynamic Sync</div>
                   <p className="text-[7px] opacity-40 leading-relaxed italic">自転速度を地球の実際の物理挙動に同期させます。係数が高いほど、観測点の通過速度が増大します。</p>
                </div>
              </div>
            )}

            {activeTab === 'clockSettings' && (
              <div className="space-y-6">
                <SelectGroup label={t.clockType} options={['digital', 'analog']} value={clockConfig.clockType} icon={<Watch size={10}/>} onChange={v => setClockConfig(s => ({...s, clockType: v}))} />
                <SelectGroup label={t.fontFamily} options={['mono', 'sans', 'serif']} value={clockConfig.fontFamily} icon={<Type size={10}/>} onChange={v => setClockConfig(s => ({...s, fontFamily: v}))} />
                <SliderItem label={t.clockSize} icon={<Maximize2 size={10}/>} value={clockConfig.clockSize} min={0.5} max={2.0} step={0.01} onChange={v => setClockConfig(s => ({...s, clockSize: v}))} />
                
                {clockConfig.clockType === 'analog' && (
                  <>
                    <SelectGroup label={t.indexType} options={['full', 'quad', 'none']} value={clockConfig.indexType} icon={<Grid size={10}/>} onChange={v => setClockConfig(s => ({...s, indexType: v}))} />
                    <SelectGroup label={t.handType} options={['tapered', 'minimal', 'block']} value={clockConfig.handType} icon={<Watch size={10}/>} onChange={v => setClockConfig(s => ({...s, handType: v}))} />
                  </>
                )}

                <div className="grid grid-cols-2 gap-2">
                  <ToggleItem label={t.showSeconds} active={clockConfig.showSeconds} onClick={() => setClockConfig(s => ({...s, showSeconds: !s.showSeconds}))} />
                  <ToggleItem label={t.showMilli} active={clockConfig.showMilli} onClick={() => setClockConfig(s => ({...s, showMilli: !s.showMilli}))} />
                  {clockConfig.clockType === 'analog' && (
                    <div className="col-span-2">
                      <ToggleItem label={t.showFrame} active={clockConfig.showFrame} onClick={() => setClockConfig(s => ({...s, showFrame: !s.showFrame}))} />
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* パネル下部のステータス */}
        <div className="px-6 py-4 border-t border-white/5 bg-black/20 flex justify-between items-center text-[7px] tracking-[0.3em] font-mono opacity-40">
           <span>MEM_SYNC_OK</span>
           <span>EST: 2026.02.07</span>
        </div>
      </div>

      {/* 3Dコンテンツ描画層 */}
      <MassivePointsGlobe data={archiveData} settings={settings} theme={theme} />

      {/* システムフッター (デジタル時計 & 稼働ステータス) */}
      <footer className="absolute bottom-10 left-10 z-50 transition-all duration-1000">
          <div className={`p-3 backdrop-blur-3xl rounded-xl border border-white/5 flex items-center gap-5 transition-all duration-1000 ${clockMode ? 'opacity-20 translate-y-2' : 'opacity-100'} ${currentTheme.ui}`}>
             <div className="flex items-center gap-2">
               <Cpu size={12} className="text-cyan-500 opacity-60" />
               <span className={`text-[8px] font-mono tracking-widest ${currentTheme.text} opacity-40 uppercase`}>
                 PHYSICAL_ROT_SYNC: {settings.rotationSpeed.toFixed(0)}
               </span>
             </div>
             <div className="w-[1px] h-3 bg-white/5" />
             <PrecisionClock theme={theme} config={clockConfig} isMainMode={false} lang={lang} />
          </div>
      </footer>

      {/* フォーカスモード切り替えボタン */}
      <div className="absolute bottom-10 right-10 z-50">
        <button 
          onClick={() => setClockMode(!clockMode)}
          className={`group w-10 h-10 flex items-center justify-center rounded-full backdrop-blur-3xl border border-white/10 transition-all duration-500 ${clockMode ? 'bg-cyan-500 text-white border-none shadow-lg shadow-cyan-500/30' : currentTheme.text + ' ' + currentTheme.ui}`}>
          <Clock size={16} className={clockMode ? "" : "group-hover:text-cyan-400 transition-colors"} />
        </button>
      </div>

      {/* インラインスタイル: フォント読み込みと特殊アニメーション */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Serif+JP:wght@900&family=Noto+Sans+JP:wght@400;900&display=swap');
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type='range']::-webkit-slider-thumb {
          -webkit-appearance: none;
          height: 8px; width: 8px; border-radius: 50%;
          background: #06b6d4; cursor: pointer;
          box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }
        body { margin: 0; padding: 0; background: black; touch-action: none; overflow: hidden; }
      `}</style>
    </div>
  );
};

export default App;
